<!DOCTYPE html>
<html lang="mn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rehome Today - Өрөөний дизайн үүсгэх</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'sans': ['Inter', 'system-ui', 'sans-serif'],
                    },
                    colors: {
                        'primary': {
                            50: '#f3e8ff',
                            100: '#e9d5ff',
                            200: '#d8b4fe',
                            300: '#c084fc',
                            400: '#a855f7',
                            500: '#9333ea',
                            600: '#7e22ce',
                            700: '#6b21a8',
                            800: '#581c87',
                            900: '#4c1d95',
                        }
                    }
                }
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        body {
            margin: 0;
            padding: 0;
        }
    </style>
</head>
<body class="font-sans bg-gray-900 text-white antialiased">
<script>
    // Authentication check
    fetch('/api/dashboard/')
        .then(response => {
            if (!response.ok) {
                window.location.href = '/';
            }
        })
        .catch(() => {
            window.location.href = '/';
        });
</script>

<!-- Site Header -->
<header class="bg-gray-900/95 backdrop-blur-sm border-b border-gray-800 h-16 fixed top-0 left-0 right-0 z-10">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-full flex justify-between items-center">
        <a href="/" class="flex items-center hover:opacity-80 transition-opacity">
            <div class="w-8 h-8 bg-primary-500 rounded-lg flex items-center justify-center">
                <span class="text-white font-bold text-sm">R</span>
            </div>
            <span class="ml-2 text-lg sm:text-xl font-bold text-white">ReHome AI</span>
        </a>
        <div class="flex items-center space-x-2 sm:space-x-4">
            <div class="flex items-center bg-gray-800 px-2 sm:px-4 py-2 rounded-lg border border-gray-700">
                <span class="text-xs sm:text-sm text-gray-400 mr-1 sm:mr-2 hidden sm:inline">Free plan</span>
                <span class="text-xs sm:text-sm font-semibold text-white">Кредит: <span id="credit-balance">3</span></span>
            </div>
            <a href="/app/profile/" class="flex items-center space-x-1 sm:space-x-2 px-2 sm:px-3 py-2 rounded-lg hover:bg-gray-800 transition-colors cursor-pointer">
                <div class="w-7 h-7 sm:w-8 sm:h-8 bg-primary-500 rounded-full flex items-center justify-center">
                    <span class="text-white font-semibold text-xs sm:text-sm" id="user-initial">U</span>
                </div>
                <div class="flex flex-col hidden sm:flex">
                    <span class="text-sm font-semibold text-white" id="header-username">User</span>
                    <span class="text-xs text-gray-400 hidden md:inline" id="header-email">email@example.com</span>
                </div>
                <svg class="w-4 h-4 text-gray-400 hidden sm:block" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                </svg>
            </a>
            <a href="/logout/" class="text-gray-400 hover:text-white transition-colors p-1 sm:p-0" title="Гарах">
                <svg class="w-5 h-5 sm:w-6 sm:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                </svg>
            </a>
        </div>
    </div>
</header>

<!-- Main Content Area -->
<div class="min-h-screen bg-gray-900 pt-16">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 sm:py-6 lg:py-8">
        <div class="flex flex-col lg:flex-row gap-4 sm:gap-6 lg:gap-8">
            <!-- Side Menu -->
            <aside class="hidden lg:block w-64 bg-gray-800 rounded-xl border border-gray-700 flex-shrink-0 self-start sticky top-24">
                <nav class="flex-1 p-4 space-y-1">
                    <a href="/app/" class="flex items-center px-4 py-2.5 text-gray-300 hover:bg-gray-700 rounded-lg transition-colors">
                        <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>
                        </svg>
                        <span class="text-sm font-medium">Нүүр</span>
                    </a>
                    <a href="/app/" class="flex items-center px-4 py-2.5 bg-primary-600 text-white rounded-lg">
                        <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                        </svg>
                        <span class="text-sm font-medium">Интерьер</span>
                    </a>
                    <div class="flex items-center px-4 py-2.5 text-gray-500 opacity-50 cursor-not-allowed rounded-lg">
                        <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"></path>
                        </svg>
                        <span class="text-sm font-medium">Сайжруулах</span>
                        <span class="ml-auto text-xs text-gray-500">Удахгүй</span>
                    </div>
                    <div class="flex items-center px-4 py-2.5 text-gray-500 opacity-50 cursor-not-allowed rounded-lg">
                        <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01"></path>
                        </svg>
                        <span class="text-sm font-medium">Өнгөт болгох</span>
                        <span class="ml-auto text-xs text-gray-500">Удахгүй</span>
                    </div>
                    <div class="flex items-center px-4 py-2.5 text-gray-500 opacity-50 cursor-not-allowed rounded-lg">
                        <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
                        </svg>
                        <span class="text-sm font-medium">Байршуулах</span>
                        <span class="ml-auto text-xs text-gray-500">Удахгүй</span>
                    </div>
                    <div class="flex items-center px-4 py-2.5 text-gray-500 opacity-50 cursor-not-allowed rounded-lg">
                        <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path>
                        </svg>
                        <span class="text-sm font-medium">Засварлах</span>
                        <span class="ml-auto text-xs text-gray-500">Удахгүй</span>
                    </div>
                    <div class="flex items-center px-4 py-2.5 text-gray-500 opacity-50 cursor-not-allowed rounded-lg">
                        <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                        </svg>
                        <span class="text-sm font-medium">Moodboard</span>
                        <span class="ml-auto text-xs text-gray-500">Удахгүй</span>
                    </div>
                    <div class="flex items-center px-4 py-2.5 text-gray-500 opacity-50 cursor-not-allowed rounded-lg">
                        <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <span class="text-sm font-medium">Видео</span>
                        <span class="ml-auto text-xs text-gray-500">Удахгүй</span>
                    </div>
                </nav>

                <!-- Secondary Navigation -->
                <div class="p-4 border-t border-gray-700 space-y-1">
                    <a href="#" class="flex items-center px-4 py-2.5 text-gray-300 hover:bg-gray-700 rounded-lg transition-colors">
                        <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
                        </svg>
                        <span class="text-sm font-medium">Заавар</span>
                    </a>
                    <a href="#" onclick="openAccountModal(); return false;" class="flex items-center px-4 py-2.5 text-gray-300 hover:bg-gray-700 rounded-lg transition-colors">
                        <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <span class="text-sm font-medium">Түүх</span>
                    </a>
                    <a href="/app/profile/" class="flex items-center px-4 py-2.5 text-gray-300 hover:bg-gray-700 rounded-lg transition-colors">
                        <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                        </svg>
                        <span class="text-sm font-medium">Профайл</span>
                    </a>
                </div>
            </aside>

            <!-- Main Content -->
            <main class="flex-1">
                <div class="space-y-4 sm:space-y-6 lg:space-y-8">
            <!-- Page Title -->
            <div class="mb-4 sm:mb-6 lg:mb-8">
                <h1 class="text-2xl sm:text-3xl font-bold text-white">Интерьер дизайн</h1>
            </div>

            <!-- Result Section -->
            <div id="result" class="bg-gray-800 rounded-xl border border-gray-700 p-4 sm:p-6 hidden mb-6 sm:mb-8">
                <!-- Title centered at top -->
                <div class="text-center mb-4 sm:mb-6">
                    <h3 id="result-title" class="text-lg sm:text-xl font-bold text-white mb-3 sm:mb-4">Living Room, Minimalist Haven</h3>
                    </div>
                <div id="comparison-container" class="grid grid-cols-1 md:grid-cols-2 gap-4 sm:gap-6 mb-4 sm:mb-6">
                    <!-- Original Image (Left) -->
                    <div class="space-y-3">
                        <div class="bg-gray-700 rounded-lg overflow-hidden border border-gray-600 relative" style="min-height: 300px; height: auto; max-height: 500px; display: flex; align-items: center; justify-content: center;">
                            <div class="absolute top-2 left-2 bg-gray-900/75 text-white px-2 sm:px-3 py-1 rounded-md text-xs sm:text-sm font-semibold z-10">
                                Original
                            </div>
                            <img id="result-original-img" src="" alt="Original" class="w-full h-full object-cover">
                        </div>
                    </div>
                    <!-- Generated Image (Right) -->
                    <div class="space-y-3">
                        <div id="generated-container" class="bg-gray-700 rounded-lg overflow-hidden border border-gray-600 relative" style="min-height: 300px; height: auto; max-height: 500px; display: flex; align-items: center; justify-content: center;">
                            <div class="absolute top-2 left-2 bg-gray-900/75 text-white px-2 sm:px-3 py-1 rounded-md text-xs sm:text-sm font-semibold z-10">
                                Generated
                            </div>
                            <!-- Watermark overlay -->
                            <div id="watermark-overlay" class="absolute bottom-2 right-2 bg-black/60 text-white px-2 sm:px-3 py-1 sm:py-1.5 rounded-md text-xs font-medium z-10 hidden">
                                www.rehome.today
                            </div>
                            <!-- Progress bar will be shown here initially -->
                            <div id="progress-container" class="w-full px-4 sm:px-8">
                                <div class="w-full bg-gray-600 rounded-full h-2 mb-2">
                                    <div id="progress-bar" class="bg-primary-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                                </div>
                                <p id="progress-text" class="text-center text-gray-300 text-xs sm:text-sm">0%</p>
                            </div>
                            <!-- Generated image will be shown here when ready -->
                            <img id="result-generated-img" src="" alt="Generated" class="w-full h-full object-cover hidden">
                        </div>
                    </div>
                </div>
                <!-- Download buttons -->
                <div class="flex flex-col sm:flex-row justify-center gap-2 sm:gap-3">
                    <button id="download-generated-btn" class="bg-primary-600 text-white px-4 sm:px-6 py-2 rounded-lg hover:bg-primary-700 transition-colors font-semibold text-xs sm:text-sm hidden flex items-center justify-center gap-2">
                        <svg class="w-4 h-4 sm:w-5 sm:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                        </svg>
                        <span class="hidden sm:inline">Generated Image татах</span>
                        <span class="sm:hidden">Татах</span>
                    </button>
                    <button id="download-compared-btn" class="bg-gray-700 text-white px-4 sm:px-6 py-2 rounded-lg hover:bg-gray-600 transition-colors font-semibold text-xs sm:text-sm hidden flex items-center justify-center gap-2">
                        <svg class="w-4 h-4 sm:w-5 sm:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                        </svg>
                        <span class="hidden sm:inline">Харьцуулсан зураг татах</span>
                        <span class="sm:hidden">Харьцуулах</span>
                    </button>
                </div>
            </div>
            
            <!-- Upload Image Section -->
                <div class="bg-gray-800 rounded-xl border border-gray-700 p-4 sm:p-6">
                    <div class="flex justify-between items-center mb-3 sm:mb-4">
                        <h2 class="text-lg sm:text-xl font-bold text-white">1. Зураг байршуулах</h2>
                    </div>

                    <!-- Recent Images -->
                    <div id="recent-images-container" class="mb-3 sm:mb-4 hidden">
                        <p class="text-xs sm:text-sm font-semibold text-gray-300 mb-2">Сүүлийн upload хийсэн зураг</p>
                        <div class="flex space-x-2 sm:space-x-3 overflow-x-auto" id="recent-images-list">
                            <!-- Recent images will be loaded here -->
                        </div>
                    </div>

                    <!-- Upload Area -->
                    <div class="border-2 border-dashed border-gray-600 rounded-lg p-6 sm:p-12 text-center hover:border-primary-500 transition-colors cursor-pointer" id="upload-area">
                        <label for="image" class="cursor-pointer">
                            <svg class="mx-auto h-8 w-8 sm:h-12 sm:w-12 text-gray-500 mb-3 sm:mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                            </svg>
                            <p class="text-base sm:text-lg font-semibold text-white mb-1 sm:mb-2">Зураг байршуулах</p>
                            <p class="text-xs sm:text-sm text-gray-400 mb-1">эсвэл файл буулга</p>
                            <p class="text-xs text-gray-500">Бид JPG, JPEG, PNG дэмжиж байна</p>
                            <input id="image" name="image" type="file" class="sr-only" accept="image/*" required>
                        </label>
                    </div>
                    <div id="image-preview" class="mt-4 hidden">
                        <div class="relative">
                            <img id="preview-img" class="max-w-full h-64 object-cover rounded-lg mx-auto" alt="Урьдчилсан харалт">
                            <button id="remove-image-btn" class="absolute top-2 right-2 bg-red-500 hover:bg-red-600 text-white rounded-full p-2 shadow-lg transition-colors" title="Зураг арилгах">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                        <div class="mt-3 text-center">
                            <label for="image" class="inline-block text-sm text-gray-400 hover:text-gray-300 cursor-pointer underline">
                                Өөр зураг сонгох
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Room Type and Interior Style Section -->
                <div class="bg-gray-800 rounded-xl border border-gray-700 p-4 sm:p-6">
                    <!-- Room Type Section -->
                    <div class="mb-6 sm:mb-8">
                        <h2 class="text-lg sm:text-xl font-bold text-white mb-3 sm:mb-4">2. Өрөөний төрөл сонгох</h2>
                        
                        <!-- Room Type Buttons -->
                        <div class="flex flex-wrap gap-2">
                            <button class="room-type-btn px-3 sm:px-4 py-1.5 sm:py-2 bg-gray-700 text-gray-300 rounded-lg hover:bg-gray-600 transition-colors text-xs sm:text-sm" data-room-mn="Зочны өрөө" data-room-en="Living Room">Зочны өрөө</button>
                            <button class="room-type-btn px-3 sm:px-4 py-1.5 sm:py-2 bg-gray-700 text-gray-300 rounded-lg hover:bg-gray-600 transition-colors text-xs sm:text-sm" data-room-mn="Унтлагын өрөө" data-room-en="Bedroom">Унтлагын өрөө</button>
                            <button class="room-type-btn px-3 sm:px-4 py-1.5 sm:py-2 bg-gray-700 text-gray-300 rounded-lg hover:bg-gray-600 transition-colors text-xs sm:text-sm" data-room-mn="Гал тогоо" data-room-en="Kitchen">Гал тогоо</button>
                            <button class="room-type-btn px-3 sm:px-4 py-1.5 sm:py-2 bg-gray-700 text-gray-300 rounded-lg hover:bg-gray-600 transition-colors text-xs sm:text-sm" data-room-mn="Хоолны өрөө" data-room-en="Dining Room">Хоолны өрөө</button>
                            <button class="room-type-btn px-3 sm:px-4 py-1.5 sm:py-2 bg-gray-700 text-gray-300 rounded-lg hover:bg-gray-600 transition-colors text-xs sm:text-sm" data-room-mn="Угаалгын өрөө" data-room-en="Laundry Room">Угаалгын өрөө</button>
                            <button class="room-type-btn px-3 sm:px-4 py-1.5 sm:py-2 bg-gray-700 text-gray-300 rounded-lg hover:bg-gray-600 transition-colors text-xs sm:text-sm" data-room-mn="Хүүхдийн өрөө" data-room-en="Kids Room">Хүүхдийн өрөө</button>
                            <button class="room-type-btn px-3 sm:px-4 py-1.5 sm:py-2 bg-gray-700 text-gray-300 rounded-lg hover:bg-gray-600 transition-colors text-xs sm:text-sm" data-room-mn="Ажлын өрөө" data-room-en="Office">Ажлын өрөө</button>
                        </div>
                    </div>

                    <!-- Interior Style Section -->
                    <div>
                        <h2 class="text-lg sm:text-xl font-bold text-white mb-3 sm:mb-4">3. Интерьерийн хэв маяг сонгох</h2>
                        
                        <div id="interior-style-container" class="grid grid-cols-2 sm:grid-cols-3 gap-3 sm:gap-4">
                            <!-- Interior styles will be loaded dynamically -->
                        </div>
                    </div>
                </div>

                <!-- Add Details Section -->
                <div class="bg-gray-800 rounded-xl border border-gray-700 p-4 sm:p-6">
                    <h2 class="text-lg sm:text-xl font-bold text-white mb-3 sm:mb-4">4. Дэлгэрэнгүй мэдээлэл нэмэх</h2>
                    
                    <div class="space-y-3 sm:space-y-4">
                        <div>
                            <label class="block text-xs sm:text-sm font-semibold text-white mb-2">Дизайнаа тайлбарла!</label>
                            <textarea id="description" class="w-full px-3 sm:px-4 py-2 sm:py-3 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent text-white placeholder-gray-400 text-sm sm:text-base" rows="3" placeholder="Жишээ: Орчин үеийн гостийн өрөө том цонхтой, саармаг өнгөтэй"></textarea>
                        </div>

                        <!-- Low Credit Warning -->
                        <div id="low-credit-warning" class="hidden bg-yellow-900/50 border border-yellow-700 rounded-lg p-4">
                            <div class="flex items-start">
                                <svg class="w-5 h-5 text-yellow-400 mr-3 mt-0.5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                                </svg>
                                <div class="flex-1">
                                    <h3 class="text-sm font-semibold text-yellow-300 mb-1">Кредит дуусаж байна!</h3>
                                    <p class="text-sm text-yellow-200 mb-3">Таны кредит <span id="current-credit-count">0</span> байна. Зураг үүсгэхэд 1 кредит шаардлагатай.</p>
                                    <button onclick="purchaseCredits()" class="bg-primary-600 text-white px-4 py-2 rounded-lg text-sm font-semibold hover:bg-primary-700 transition-colors">
                                        Кредит худалдаж авах →
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="flex flex-col sm:flex-row items-stretch sm:items-center justify-between pt-3 sm:pt-4 gap-3 sm:gap-0">
                    <div class="text-xs sm:text-sm text-gray-400">
                        <span class="font-medium">Зардал:</span> 1 кредит
                            </div>
                            <button id="render-btn" type="button" class="bg-primary-600 text-white px-6 sm:px-8 py-2.5 sm:py-3 rounded-lg font-semibold text-sm sm:text-base hover:bg-primary-700 transition-all duration-200 transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none w-full sm:w-auto">
                                <span id="submit-text">Үүсгэх</span>
                                <span id="loading-text" class="hidden">Үүсгэж байна...</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Prompt Preview Section -->
                <div id="prompt-preview" class="bg-gray-800 rounded-xl border border-gray-700 p-4 sm:p-6 hidden">
                    <h3 class="text-base sm:text-lg font-semibold text-white mb-3 sm:mb-4">Prompt Preview</h3>
                    <div class="bg-gray-700 rounded-lg p-3 sm:p-4 mb-3 sm:mb-4">
                        <p id="prompt-text" class="text-xs sm:text-sm text-gray-300"></p>
                    </div>
                    <button id="confirm-render-btn" class="w-full bg-primary-600 text-white px-6 sm:px-8 py-2.5 sm:py-3 rounded-lg font-semibold text-sm sm:text-base hover:bg-primary-700 transition-all duration-200">
                        Үүсгэх
                    </button>
                </div>
                </div>
            </main>
        </div>
    </div>
</div>

<!-- Account Modal -->
<div id="account-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 z-50 hidden overflow-y-auto">
    <div class="flex items-center justify-center min-h-screen p-2 sm:p-4">
        <div class="bg-gray-800 rounded-lg shadow-xl max-w-4xl w-full max-h-[95vh] sm:max-h-[90vh] overflow-y-auto border border-gray-700">
            <div class="p-4 sm:p-6">
                <div class="flex justify-between items-center mb-4 sm:mb-6">
                    <h2 class="text-xl sm:text-2xl font-bold text-white">Аккаунт</h2>
                    <button onclick="closeAccountModal()" class="text-gray-400 hover:text-white">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>

                <!-- User Info Section -->
                <div class="bg-gradient-to-r from-primary-500 to-primary-600 rounded-lg shadow-lg p-6 mb-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="text-xl font-bold text-white mb-2" id="account-username">User</h3>
                            <p class="text-primary-100" id="account-email">email@example.com</p>
                        </div>
                        <div class="text-right">
                            <div class="text-3xl font-bold text-white mb-1" id="account-credit-balance">0</div>
                            <p class="text-primary-100 text-sm">Кредит</p>
                        </div>
                    </div>
                </div>

                <!-- Credits Section -->
                <div class="bg-gray-700 rounded-lg border border-gray-600 mb-6">
                    <div class="px-6 py-4 border-b border-gray-600">
                        <div class="flex justify-between items-center">
                            <h3 class="text-lg font-medium text-white">Credits</h3>
                            <button onclick="purchaseCredits()" class="bg-primary-600 text-white px-4 py-2 rounded-md text-sm font-medium hover:bg-primary-700 transition-colors">
                                Кредит худалдаж авах
                            </button>
                        </div>
                    </div>
                    <div class="px-6 py-4">
                        <div class="flex items-center justify-between mb-4">
                            <span class="text-gray-300">Одоогийн баланс:</span>
                            <span class="text-2xl font-bold text-white" id="modal-credit-balance">0</span>
                        </div>
                        <p class="text-sm text-gray-400">Зураг үүсгэх бүрт 1 кредит зарцуулна</p>
                    </div>
                </div>

                <!-- Purchase Credits Modal -->
                <div id="purchase-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden z-60">
                    <div class="flex items-center justify-center min-h-screen p-2 sm:p-4">
                        <div class="bg-gray-800 rounded-lg shadow-xl max-w-4xl w-full border border-gray-700 max-h-[95vh] sm:max-h-[90vh] overflow-y-auto">
                            <div class="p-4 sm:p-6">
                                <div class="flex justify-between items-center mb-4 sm:mb-6">
                                    <h3 class="text-xl sm:text-2xl font-bold text-white">Кредит худалдаж авах</h3>
                                    <button onclick="closePurchaseModal()" class="text-gray-400 hover:text-white p-1">
                                        <svg class="w-5 h-5 sm:w-6 sm:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                        </svg>
                                    </button>
                                </div>
                                <div id="packages-list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 sm:gap-4 overflow-visible">
                                    <div class="text-center text-gray-400 py-6 sm:py-8 text-sm sm:text-base">Багцуудыг ачаалж байна...</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- QPay Payment Modal -->
                <div id="qpay-payment-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden z-70">
                    <div class="flex items-center justify-center min-h-screen p-2 sm:p-4">
                        <div class="bg-gray-800 rounded-lg shadow-xl max-w-2xl w-full border border-gray-700 max-h-[95vh] sm:max-h-[90vh] overflow-y-auto">
                            <div class="p-4 sm:p-6">
                                <div class="flex justify-between items-center mb-4 sm:mb-6">
                                    <h3 class="text-xl sm:text-2xl font-bold text-white">Төлбөр төлөх</h3>
                                    <button onclick="closeQPayPaymentModal()" class="text-gray-400 hover:text-white p-1">
                                        <svg class="w-5 h-5 sm:w-6 sm:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                        </svg>
                                    </button>
                                </div>
                                
                                <!-- QR Code Section -->
                                <div id="qpay-qr-section" class="text-center mb-4 sm:mb-6">
                                    <div class="bg-white rounded-lg p-3 sm:p-6 inline-block mb-3 sm:mb-4">
                                        <img id="qpay-qr-image" src="" alt="QR Code" class="w-48 h-48 sm:w-64 sm:h-64 mx-auto">
                            </div>
                                    <p class="text-xs sm:text-sm text-gray-400 mb-3 sm:mb-4">QR кодыг утасныхаа камераар уншуулна уу</p>
                                    <a id="qpay-short-url" href="#" target="_blank" class="text-primary-400 hover:text-primary-300 text-xs sm:text-sm underline break-all">
                                        Богино холбоос
                                    </a>
                                </div>
                                
                                <!-- Payment Apps Section -->
                                <div id="qpay-apps-section" class="mb-4 sm:mb-6">
                                    <h3 class="text-base sm:text-lg font-semibold text-white mb-3 sm:mb-4">Төлбөрийн апп сонгох</h3>
                                    <div id="qpay-apps-grid" class="grid grid-cols-2 sm:grid-cols-3 gap-2 sm:gap-3">
                                        <!-- Payment apps will be loaded here -->
                                    </div>
                                </div>
                                
                                <!-- Loading State -->
                                <div id="qpay-loading" class="text-center py-8">
                                    <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-primary-500"></div>
                                    <p class="text-gray-400 mt-4">Төлбөрийн мэдээлэл бэлдэж байна...</p>
                                </div>
                                
                                <!-- Error State -->
                                <div id="qpay-error" class="hidden bg-red-900 border border-red-700 text-red-200 px-4 py-3 rounded-lg text-sm mb-4">
                                </div>
                                
                                <!-- Success State -->
                                <div id="qpay-success" class="hidden bg-green-900 border border-green-700 text-green-200 px-4 py-3 rounded-lg text-sm mb-4">
                                    <div class="flex items-center">
                                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                                        </svg>
                                        <div>
                                            <p class="font-semibold">Төлбөр амжилттай төлөгдлөө!</p>
                                            <p id="qpay-success-credits" class="text-sm mt-1"></p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Recent Transactions -->
                <div class="bg-gray-700 rounded-lg border border-gray-600 mb-6">
                    <div class="px-6 py-4 border-b border-gray-600">
                        <h3 class="text-lg font-medium text-white">Сүүлийн гүйлгээ</h3>
                    </div>
                    <div class="divide-y divide-gray-600" id="modal-transactions-list">
                        <div class="px-6 py-4 text-gray-400 text-center">Ачааллаж байна...</div>
                    </div>
                </div>

                <!-- Generated Designs -->
                <div class="bg-gray-700 rounded-lg border border-gray-600">
                    <div class="px-6 py-4 border-b border-gray-600">
                        <h3 class="text-lg font-medium text-white">Таны үүсгэсэн дизайнууд</h3>
                    </div>
                    <div class="p-6">
                        <div id="modal-images-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 sm:gap-6">
                            <div class="text-center py-8 sm:py-12 text-gray-400 text-sm sm:text-base">Ачааллаж байна...</div>
                        </div>
                        <div id="modal-no-images" class="text-center py-12 hidden">
                            <svg class="mx-auto h-12 w-12 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                            </svg>
                            <h3 class="mt-2 text-sm font-medium text-white">Одоогоор дизайн байхгүй</h3>
                            <p class="mt-1 text-sm text-gray-400">Эхний дизайнаа үүсгээд эхэлнэ үү.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Set up download button event listeners
    const downloadGeneratedBtn = document.getElementById('download-generated-btn');
    const downloadComparedBtn = document.getElementById('download-compared-btn');
    
    if (downloadGeneratedBtn) {
        downloadGeneratedBtn.addEventListener('click', downloadGeneratedImage);
    }
    
    if (downloadComparedBtn) {
        downloadComparedBtn.addEventListener('click', downloadComparedImage);
    }
    
    const imageInput = document.getElementById('image');
    const imagePreview = document.getElementById('image-preview');
    const previewImg = document.getElementById('preview-img');
    const uploadArea = document.getElementById('upload-area');
    const submitText = document.getElementById('submit-text');
    const loadingText = document.getElementById('loading-text');
    const result = document.getElementById('result');
    const renderBtn = document.getElementById('render-btn');

    // Interior style data with image URLs (using Unsplash Source API for better quality images)
    const interiorStyles = [
    { "en": "Minimalist Haven", "mn": "Минималист орчин", "image": "/static/interior_styles/minimalist-haven.webp" },
    { "en": "Modern Fusion", "mn": "Орчин үеийн хослол", "image": "/static/interior_styles/modern-fusion.webp" },
    { "en": "Contemporary Elegance", "mn": "Орчин үеийн тансаг байдал", "image": "/static/interior_styles/contemporary-elegance.webp" },
    { "en": "Industrial Loft", "mn": "Аж үйлдвэрийн хэв маяг", "image": "/static/interior_styles/industrial-loft.webp" },
    { "en": "Bohemian Oasis", "mn": "Богемийн уур амьсгал", "image": "/static/interior_styles/bohemian-oasis.webp" },
    { "en": "Coastal Breeze", "mn": "Далайн эргийн сэрүүн уур амьсгал", "image": "/static/interior_styles/coastal-breeze.webp" },
    { "en": "Desert Retreat", "mn": "Цөлийн амралтын хэв маяг", "image": "/static/interior_styles/desert-retreat.webp" },
    { "en": "Mountain Escape", "mn": "Уулын амралтын хэв маяг", "image": "/static/interior_styles/mountain-escape.webp" },
    { "en": "Victorian Elegance", "mn": "Викториан тансаг байдал", "image": "/static/interior_styles/victorian-elegance.webp" },
    { "en": "Art Deco Glamour", "mn": "Арт Деко гоёл чимэглэл", "image": "/static/interior_styles/art-deco-glamour.webp" },
    { "en": "Mid-Century Modern", "mn": "20-р зууны дунд үеийн орчин үеийн хэв маяг", "image": "/static/interior_styles/mid-century-modern.webp" },
    { "en": "French Country Charm", "mn": "Франц загварын хөдөөгийн хэв маяг", "image": "/static/interior_styles/french-country-charm.webp" },
    { "en": "Colonial Classic", "mn": "Колони хэв маягийн сонгодог орчин", "image": "/static/interior_styles/colonial-classic.webp" },
    { "en": "Scandinavian Sanctuary", "mn": "Скандинав минимал орчин", "image": "/static/interior_styles/scandinavian-sanctuary.webp" },
    { "en": "Japanese Zen", "mn": "Япон Зэн хэв маяг", "image": "/static/interior_styles/japanese-zen.webp" }
];


    // Selected values
    let selectedRoomType = '';
    let selectedRoomTypeMn = ''; // Mongolian version for display
    let selectedInteriorStyle = '';
    let selectedRecentImageFile = null;

    // Initialize room type buttons
    function initializeRoomTypes() {
        // Room type button click handlers
        document.querySelectorAll('.room-type-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const roomMn = this.dataset.roomMn;
                const roomEn = this.dataset.roomEn;
                
                // Update selected room (store both versions)
                selectedRoomType = roomEn;
                selectedRoomTypeMn = roomMn;
                
                // Remove all active states first
                document.querySelectorAll('.room-type-btn').forEach(b => {
                    // Temporarily disable transition
                    b.style.transition = 'none';
                    b.classList.remove('bg-primary-600', 'text-white');
                    b.classList.add('bg-gray-700', 'text-gray-300');
                    // Re-enable transition after a brief moment
                    setTimeout(() => {
                        b.style.transition = '';
                    }, 10);
                });
                
                // Add active state to clicked button
                this.style.transition = 'none';
                this.classList.remove('bg-gray-700', 'text-gray-300');
                this.classList.add('bg-primary-600', 'text-white');
                setTimeout(() => {
                    this.style.transition = '';
                }, 10);
            });
        });
    }

    // Populate interior styles
    function populateInteriorStyles() {
        const container = document.getElementById('interior-style-container');
        let html = '';
        
        interiorStyles.forEach(style => {
            html += `<button class="interior-style-btn bg-gray-700 rounded-lg p-4 text-center cursor-pointer hover:bg-gray-600 transition-all overflow-hidden group border-2 border-transparent" data-style="${style.en}">
                <div class="w-full h-32 rounded mb-2 overflow-hidden bg-gray-600">
                    <img src="${style.image}" alt="${style.mn}" class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=\\'http://www.w3.org/2000/svg\\' width=\\'400\\' height=\\'300\\'%3E%3Crect fill=\\'%234b5563\\' width=\\'400\\' height=\\'300\\'/%3E%3C/svg%3E'">
                </div>
                <p class="text-sm font-medium text-white">${style.mn}</p>
                <p class="text-xs text-gray-400 mt-1">${style.en}</p>
            </button>`;
        });
        
        container.innerHTML = html;
        
        // Add click handlers
        document.querySelectorAll('.interior-style-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.interior-style-btn').forEach(b => {
                    b.classList.remove('ring-4', 'ring-primary-500', 'ring-offset-2', 'bg-primary-600', 'border-primary-500');
                    b.classList.add('bg-gray-700', 'border-transparent');
                    const paragraphs = b.querySelectorAll('p');
                    paragraphs.forEach(p => {
                        if (p.classList.contains('text-xs')) {
                            // English name - keep gray for both states
                            return;
                        }
                        p.classList.remove('text-primary-300', 'font-bold');
                        p.classList.add('text-white');
                    });
                });
                this.classList.add('ring-4', 'ring-primary-500', 'ring-offset-2', 'bg-primary-600', 'border-primary-500');
                this.classList.remove('bg-gray-700', 'border-transparent');
                const paragraphs = this.querySelectorAll('p');
                paragraphs.forEach(p => {
                    if (p.classList.contains('text-xs')) {
                        // English name - keep gray for both states
                        return;
                    }
                    p.classList.add('text-primary-100', 'font-bold');
                    p.classList.remove('text-white');
                });
                selectedInteriorStyle = this.dataset.style;
            });
        });
    }

    // Initialize
    initializeRoomTypes();
    populateInteriorStyles();

    // Load credit balance and user info
    let currentCreditBalance = 0;
    fetch('/api/dashboard/')
        .then(response => response.json())
        .then(data => {
            currentCreditBalance = data.credit_balance || 0;
            document.getElementById('credit-balance').textContent = currentCreditBalance;
            
            // Show low credit warning if credit <= 2
            checkAndShowLowCreditWarning(currentCreditBalance);
            
            // Update user info in header
            if (data.user) {
                document.getElementById('header-username').textContent = data.user.username || 'User';
                document.getElementById('header-email').textContent = data.user.email || 'email@example.com';
                // Set user initial
                const username = data.user.username || 'U';
                document.getElementById('user-initial').textContent = username.charAt(0).toUpperCase();
            }
        });

    // Check and show low credit warning
    function checkAndShowLowCreditWarning(creditBalance) {
        const warningDiv = document.getElementById('low-credit-warning');
        const creditCountSpan = document.getElementById('current-credit-count');
        
        if (creditBalance <= 2) {
            if (creditCountSpan) {
                creditCountSpan.textContent = creditBalance;
            }
            if (warningDiv) {
                warningDiv.classList.remove('hidden');
            }
        } else {
            if (warningDiv) {
                warningDiv.classList.add('hidden');
            }
        }
    }

    // Load recent images
    function loadRecentImages() {
        fetch('/api/recent-images/')
            .then(response => response.json())
            .then(data => {
                const recentImagesContainer = document.getElementById('recent-images-container');
                const recentImagesList = document.getElementById('recent-images-list');
                
                if (data.recent_images && data.recent_images.length > 0) {
                    recentImagesList.innerHTML = '';
                    
                    data.recent_images.forEach(image => {
                        const imgDiv = document.createElement('div');
                        imgDiv.className = 'w-20 h-20 rounded-lg overflow-hidden cursor-pointer hover:opacity-80 transition-opacity border-2 border-gray-200';
                        imgDiv.innerHTML = `<img src="${image.original_image}" alt="Recent" class="w-full h-full object-cover">`;
                        
                        // Click to use this image
                        imgDiv.addEventListener('click', async function() {
                            try {
                                // Fetch image and convert to File object
                                const response = await fetch(image.original_image);
                                const blob = await response.blob();
                                const fileName = image.original_image.split('/').pop() || 'image.jpg';
                                const file = new File([blob], fileName, { type: blob.type });
                                
                                // Store the file for render
                                selectedRecentImageFile = file;
                                
                                // Clear regular image input
                                imageInput.value = '';
                                
                                // Show preview
                                previewImg.src = image.original_image;
                                imagePreview.classList.remove('hidden');
                                uploadArea.classList.add('hidden');
                                renderBtn.disabled = false;
                            } catch (error) {
                                console.error('Error loading recent image:', error);
                                alert('Зураг ачааллахад алдаа гарлаа');
                            }
                        });
                        
                        recentImagesList.appendChild(imgDiv);
                    });
                    
                    recentImagesContainer.classList.remove('hidden');
                }
            })
            .catch(error => {
                console.error('Error loading recent images:', error);
            });
    }

    // Load recent images on page load
    loadRecentImages();

    // Image preview
    imageInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            // Clear recent image selection
            selectedRecentImageFile = null;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                previewImg.src = e.target.result;
                imagePreview.classList.remove('hidden');
                uploadArea.classList.add('hidden');
                renderBtn.disabled = false;
            };
            reader.readAsDataURL(file);
        }
    });

    // Remove image functionality
    const removeImageBtn = document.getElementById('remove-image-btn');
    removeImageBtn.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        
        // Reset image input
        imageInput.value = '';
        selectedRecentImageFile = null;
        
        // Hide preview and show upload area
        imagePreview.classList.add('hidden');
        uploadArea.classList.remove('hidden');
        
        // Disable render button
        renderBtn.disabled = true;
        
        // Reset preview image src
        previewImg.src = '';
    });

    // Function to build prompt for DALL·E 3
    function buildPrompt(roomType, style, description) {
        const promptParts = [
            `Using the provided image of a ${roomType || 'room'} interior,`,
            `change the entire room design to ${style} style.`,
            "Keep the exact room layout, floor plan, windows and doors positions unchanged.",
            "Preserve the architectural elements, dimensions, and proportions.",
            "Maintain realistic proportions, natural lighting, and professional interior design quality.",
            "Only change the furniture, decor, colors, materials, and styling while keeping all structural elements identical."
        ];
        
        if (description) {
            promptParts.splice(-1, 0, `Following these specific requirements: ${description}`);
        }
        
        return promptParts.join(' ');
    }

    // Render button click - directly render without preview
    renderBtn.addEventListener('click', async function(e) {
        e.preventDefault();
        
        // Check credit balance first - only block if 0 credits
        if (currentCreditBalance <= 0) {
            // Show purchase modal
            purchaseCredits();
            return;
        }
        
        // Check for image (either from input or recent image)
        const imageFile = selectedRecentImageFile || imageInput.files[0];
        if (!imageFile) {
            alert('Зураг байршуулна уу');
            return;
        }
        
        if (!selectedRoomType) {
            alert('Өрөөний төрөл сонгоно уу');
            return;
        }
        
        if (!selectedInteriorStyle) {
            alert('Интерьерийн хэв маяг сонгоно уу');
            return;
        }
        
        // Show loading state
        submitText.classList.add('hidden');
        loadingText.classList.remove('hidden');
        renderBtn.disabled = true;
        
        // Show result section immediately and scroll to top
        showResultSection();
        
        // Prepare form data
        const formData = new FormData();
        formData.append('image', imageFile);
        formData.append('room_type', selectedRoomType);
        formData.append('style', selectedInteriorStyle);
        formData.append('description', document.getElementById('description').value);
        
        try {
            console.log('Sending generate request...');
            const response = await fetch('/api/generate/', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                },
            });
            
            console.log('Response status:', response.status);
            
            let data;
            try {
                data = await response.json();
                console.log('Response data:', data);
            } catch (jsonError) {
                console.error('JSON parse error:', jsonError);
                const text = await response.text();
                console.error('Response text:', text);
                alert('Серверээс буруу хариу ирлээ. Дахин оролдоно уу.');
                return;
            }
            
            if (response.ok) {
                console.log('Render successful, data:', data);
                console.log('Generated image data:', data.generated_image);
                
                // Update generated image when ready
                if (data.generated_image) {
                    // Check if generated_image is an object with url or direct URL string
                    const imageUrl = data.generated_image.generated_image || data.generated_image.url || data.generated_image;
                    if (imageUrl) {
                        console.log('Updating generated image with URL:', imageUrl);
                    updateGeneratedImage(data.generated_image);
                } else {
                        console.error('Generated image URL is missing in response:', data.generated_image);
                        alert('Зураг үүсгэхэд алдаа гарлаа: Зураг олдсонгүй');
                    }
                } else {
                    console.error('Generated image data is missing in response:', data);
                    alert('Зураг үүсгэхэд алдаа гарлаа: Мэдээлэл олдсонгүй');
                }
                
                // Update credit balance
                fetch('/api/dashboard/')
                    .then(response => response.json())
                    .then(data => {
                        currentCreditBalance = data.credit_balance || 0;
                        document.getElementById('credit-balance').textContent = currentCreditBalance;
                        checkAndShowLowCreditWarning(currentCreditBalance);
                    });
                
                // Reload recent images
                loadRecentImages();
            } else {
                console.error('API error:', response.status, data);
                const errorMessage = data.error || data.message || 'Алдаа гарлаа';
                alert('Алдаа: ' + errorMessage);
            }
        } catch (error) {
            console.error('Network or other error:', error);
            alert('Алдаа: ' + (error.message || 'Сүлжээний алдаа. Дахин оролдоно уу.'));
        } finally {
            // Reset form state
            submitText.classList.remove('hidden');
            loadingText.classList.add('hidden');
            renderBtn.disabled = false;
        }
    });

    // Confirm render button click - send to DALL-E
    document.getElementById('confirm-render-btn').addEventListener('click', async function(e) {
        e.preventDefault();
        
        // Check credit balance first - only block if 0 credits
        if (currentCreditBalance <= 0) {
            // Show purchase modal
            purchaseCredits();
            return;
        }
        
        // Check for image (either from input or recent image)
        const imageFile = selectedRecentImageFile || imageInput.files[0];
        if (!imageFile) {
            alert('Зураг байршуулна уу');
            return;
        }
        
        const formData = new FormData();
        formData.append('image', imageFile);
        formData.append('room_type', selectedRoomType);
        formData.append('style', selectedInteriorStyle);
        formData.append('description', document.getElementById('description').value);
        
        // Hide prompt preview and show loading
        document.getElementById('prompt-preview').classList.add('hidden');
        submitText.classList.add('hidden');
        loadingText.classList.remove('hidden');
        renderBtn.disabled = true;
        
        // Show result section immediately and scroll to top
        showResultSection();
        
        try {
            console.log('Sending generate request (confirm)...');
            const response = await fetch('/api/generate/', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                },
            });
            
            console.log('Response status:', response.status);
            
            let data;
            try {
                data = await response.json();
                console.log('Response data:', data);
            } catch (jsonError) {
                console.error('JSON parse error:', jsonError);
                const text = await response.text();
                console.error('Response text:', text);
                alert('Серверээс буруу хариу ирлээ. Дахин оролдоно уу.');
                return;
            }
            
            if (response.ok) {
                console.log('Render successful, data:', data);
                console.log('Generated image data:', data.generated_image);
                
                // Update generated image when ready
                if (data.generated_image) {
                    // Check if generated_image is an object with url or direct URL string
                    const imageUrl = data.generated_image.generated_image || data.generated_image.url || data.generated_image;
                    if (imageUrl) {
                        console.log('Updating generated image with URL:', imageUrl);
                    updateGeneratedImage(data.generated_image);
                } else {
                        console.error('Generated image URL is missing in response:', data.generated_image);
                        alert('Зураг үүсгэхэд алдаа гарлаа: Зураг олдсонгүй');
                    }
                } else {
                    console.error('Generated image data is missing in response:', data);
                    alert('Зураг үүсгэхэд алдаа гарлаа: Мэдээлэл олдсонгүй');
                }
                
                // Update credit balance
                fetch('/api/dashboard/')
                    .then(response => response.json())
                    .then(data => {
                        currentCreditBalance = data.credit_balance || 0;
                        document.getElementById('credit-balance').textContent = currentCreditBalance;
                        checkAndShowLowCreditWarning(currentCreditBalance);
                    });
                
                // Reload recent images
                loadRecentImages();
            } else {
                console.error('API error:', response.status, data);
                const errorMessage = data.error || data.message || 'Алдаа гарлаа';
                alert('Алдаа: ' + errorMessage);
            }
        } catch (error) {
            console.error('Network or other error:', error);
            alert('Алдаа: ' + (error.message || 'Сүлжээний алдаа. Дахин оролдоно уу.'));
        } finally {
            // Reset form state
            submitText.classList.remove('hidden');
            loadingText.classList.add('hidden');
            renderBtn.disabled = false;
        }
    });

    function showResultSection() {
        // Get original image source from preview (works for both new uploads and recent images)
        const imageFile = selectedRecentImageFile || imageInput.files[0];
        const originalSrc = previewImg.src || (imageFile ? URL.createObjectURL(imageFile) : '');
        
        // Get room type for title (use Mongolian version)
        const roomTypeText = selectedRoomTypeMn || selectedRoomType || 'Зочны өрөө';
        
        // Get style text (use Mongolian if available)
        let styleText = selectedInteriorStyle || 'Загвар';
        const styleObj = interiorStyles.find(s => s.en === selectedInteriorStyle || s.mn === selectedInteriorStyle);
        if (styleObj) {
            styleText = styleObj.mn;
        }
        
        // Set original image
        const originalImg = document.getElementById('result-original-img');
        const originalContainer = originalImg?.closest('.bg-gray-700');
        const generatedContainer = document.getElementById('generated-container');
        
        if (originalImg && originalSrc) {
            originalImg.src = originalSrc;
            
            // When original image loads, match its height to generated container
            originalImg.onload = function() {
                if (originalContainer && generatedContainer) {
                    // Get the natural aspect ratio of the original image
                    const aspectRatio = originalImg.naturalHeight / originalImg.naturalWidth;
                    // Get the width of the container (they should be same width in grid)
                    const containerWidth = originalContainer.offsetWidth;
                    // Calculate height based on aspect ratio
                    const calculatedHeight = containerWidth * aspectRatio;
                    // Set both containers to the same height
                    originalContainer.style.height = calculatedHeight + 'px';
                    generatedContainer.style.height = calculatedHeight + 'px';
                }
            };
        }
        
        // Set title (centered)
        const resultTitle = document.getElementById('result-title');
        if (resultTitle) {
            resultTitle.textContent = roomTypeText + ', ' + styleText;
        }
        
        // Show result section
        result.classList.remove('hidden');
        
        // Scroll to top immediately
        window.scrollTo({ top: 0, behavior: 'smooth' });
        
        // Start progress simulation (without generated image URL yet)
        startProgressSimulation(null);
    }
    
    function updateGeneratedImage(generatedImage) {
        // Get generated image URL
        let generatedImageUrl = '';
        
        if (typeof generatedImage === 'object' && generatedImage !== null) {
            generatedImageUrl = generatedImage.generated_image || generatedImage.url || '';
        } else if (typeof generatedImage === 'string') {
            generatedImageUrl = generatedImage;
        }
        
        if (generatedImageUrl) {
            // Update the progress simulation to use the actual generated image URL
            const generatedImg = document.getElementById('result-generated-img');
            const progressContainer = document.getElementById('progress-container');
            
            if (generatedImg && progressContainer) {
                // Wait for progress to complete, then show image
                // The progress simulation will handle showing the image when it reaches 100%
                if (window.progressInterval) {
                    // Store the URL to use when progress completes
                    window.pendingGeneratedImageUrl = generatedImageUrl;
                } else {
                    // If progress already completed, show image immediately
                    generatedImg.src = generatedImageUrl;
                    generatedImg.onload = () => {
                        progressContainer.classList.add('hidden');
                        generatedImg.classList.remove('hidden');
                        
                        // Match generated image height to original image height
                        const originalImg = document.getElementById('result-original-img');
                        const originalContainer = originalImg?.closest('.bg-gray-700');
                        const generatedContainer = document.getElementById('generated-container');
                        
                        if (originalContainer && generatedContainer && originalImg.complete) {
                            // Get the natural aspect ratio of the original image
                            const aspectRatio = originalImg.naturalHeight / originalImg.naturalWidth;
                            // Get the width of the container
                            const containerWidth = originalContainer.offsetWidth;
                            // Calculate height based on aspect ratio
                            const calculatedHeight = containerWidth * aspectRatio;
                            // Set both containers to the same height
                            originalContainer.style.height = calculatedHeight + 'px';
                            generatedContainer.style.height = calculatedHeight + 'px';
                        }
                        
                        // Show watermark overlay
                        const watermarkOverlay = document.getElementById('watermark-overlay');
                        if (watermarkOverlay) {
                            watermarkOverlay.classList.remove('hidden');
                        }
                        // Show download buttons
                        const downloadGeneratedBtn = document.getElementById('download-generated-btn');
                        const downloadComparedBtn = document.getElementById('download-compared-btn');
                        if (downloadGeneratedBtn) downloadGeneratedBtn.classList.remove('hidden');
                        if (downloadComparedBtn) downloadComparedBtn.classList.remove('hidden');
                    };
                }
            }
        }
    }
    
    function showComparison(generatedImage) {
        // Legacy function for compatibility - redirects to new flow
        showResultSection();
        updateGeneratedImage(generatedImage);
    }
    
    function startProgressSimulation(generatedImageUrl) {
        const progressBar = document.getElementById('progress-bar');
        const progressText = document.getElementById('progress-text');
        const progressContainer = document.getElementById('progress-container');
        const generatedImg = document.getElementById('result-generated-img');
        const generatedContainer = document.getElementById('generated-container');
        
        if (!progressBar || !progressText || !progressContainer || !generatedImg) {
            console.error('Progress elements not found');
            return;
        }
        
        // Clear any existing interval
        if (window.progressInterval) {
            clearInterval(window.progressInterval);
        }
        
        // Reset progress
        progressBar.style.width = '0%';
        progressText.textContent = '0%';
        progressContainer.classList.remove('hidden');
        generatedImg.classList.add('hidden');
        
        // Simulate progress
        let progress = 0;
        window.progressInterval = setInterval(() => {
            progress += Math.random() * 15; // Random increment between 0-15%
            if (progress > 100) progress = 100;
            
            progressBar.style.width = progress + '%';
            progressText.textContent = progress.toFixed(2) + '%';
            
            if (progress >= 100) {
                clearInterval(window.progressInterval);
                window.progressInterval = null;
                
                // Hide progress, show generated image
                setTimeout(() => {
                    // Use pending URL if available (from updateGeneratedImage), otherwise use provided URL
                    const imageUrl = window.pendingGeneratedImageUrl || generatedImageUrl;
                    
                    if (imageUrl) {
                        generatedImg.src = imageUrl;
                        generatedImg.onload = () => {
                            progressContainer.classList.add('hidden');
                            generatedImg.classList.remove('hidden');
                            
                            // Match generated image height to original image height
                            const originalImg = document.getElementById('result-original-img');
                            const originalContainer = originalImg?.closest('.bg-gray-700');
                            const generatedContainer = document.getElementById('generated-container');
                            
                            if (originalContainer && generatedContainer && originalImg.complete) {
                                // Get the natural aspect ratio of the original image
                                const aspectRatio = originalImg.naturalHeight / originalImg.naturalWidth;
                                // Get the width of the container
                                const containerWidth = originalContainer.offsetWidth;
                                // Calculate height based on aspect ratio
                                const calculatedHeight = containerWidth * aspectRatio;
                                // Set both containers to the same height
                                originalContainer.style.height = calculatedHeight + 'px';
                                generatedContainer.style.height = calculatedHeight + 'px';
                            }
                            
                            // Show watermark overlay
                            const watermarkOverlay = document.getElementById('watermark-overlay');
                            if (watermarkOverlay) {
                                watermarkOverlay.classList.remove('hidden');
                            }
                            // Show download buttons
                            const downloadGeneratedBtn = document.getElementById('download-generated-btn');
                            const downloadComparedBtn = document.getElementById('download-compared-btn');
                            if (downloadGeneratedBtn) downloadGeneratedBtn.classList.remove('hidden');
                            if (downloadComparedBtn) downloadComparedBtn.classList.remove('hidden');
                        };
                        generatedImg.onerror = () => {
                            progressText.textContent = 'Алдаа гарлаа';
                        };
                        // Clear pending URL
                        window.pendingGeneratedImageUrl = null;
                    } else {
                        // If no URL yet, wait a bit more or show waiting message
                        progressText.textContent = 'Хүлээж байна...';
                    }
                }, 500);
            }
        }, 200); // Update every 200ms
    }
    
    function getTimeAgo(date) {
        const seconds = Math.floor((new Date() - date) / 1000);
        if (seconds < 60) return seconds + 's';
        const minutes = Math.floor(seconds / 60);
        if (minutes < 60) return minutes + 'm';
        const hours = Math.floor(minutes / 60);
        if (hours < 24) return hours + 'h';
        const days = Math.floor(hours / 24);
        return days + 'd';
    }

    // Download functions
    function downloadGeneratedImage() {
        const generatedImg = document.getElementById('result-generated-img');
        if (!generatedImg || !generatedImg.src) {
            alert('Зураг олдсонгүй');
            return;
        }

        // Create canvas to add watermark
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        const img = new Image();
        img.crossOrigin = 'anonymous';
        
        img.onload = () => {
            canvas.width = img.width;
            canvas.height = img.height;
            
            // Draw the image
            ctx.drawImage(img, 0, 0);
            
            // Add watermark
            const watermarkText = 'www.rehome.today';
            const fontSize = Math.max(16, img.width / 40);
            ctx.font = `${fontSize}px Arial`;
            ctx.fillStyle = 'rgba(0, 0, 0, 0.6)';
            
            // Measure text
            const textMetrics = ctx.measureText(watermarkText);
            const textWidth = textMetrics.width;
            const textHeight = fontSize;
            const padding = 10;
            
            // Draw background
            ctx.fillRect(
                img.width - textWidth - padding * 2,
                img.height - textHeight - padding * 2,
                textWidth + padding * 2,
                textHeight + padding * 2
            );
            
            // Draw text
            ctx.fillStyle = 'white';
            ctx.fillText(
                watermarkText,
                img.width - textWidth - padding,
                img.height - padding
            );
            
            // Download
            canvas.toBlob((blob) => {
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'rehome-generated-' + Date.now() + '.png';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }, 'image/png');
        };
        
        img.onerror = () => {
            // Fallback: download without watermark if CORS issue
            const a = document.createElement('a');
            a.href = generatedImg.src;
            a.download = 'rehome-generated-' + Date.now() + '.png';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        };
        
        img.src = generatedImg.src;
    }

    function downloadComparedImage() {
        const originalImg = document.getElementById('result-original-img');
        const generatedImg = document.getElementById('result-generated-img');
        
        if (!originalImg || !originalImg.src || !generatedImg || !generatedImg.src) {
            alert('Зураг олдсонгүй');
            return;
        }

        const img1 = new Image();
        const img2 = new Image();
        img1.crossOrigin = 'anonymous';
        img2.crossOrigin = 'anonymous';
        
        let loadedCount = 0;
        const onImageLoad = () => {
            loadedCount++;
            if (loadedCount === 2) {
                // Both images loaded, create compared image
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                // Calculate dimensions - use same height for both images
                const maxHeight = Math.max(img1.height, img2.height);
                const scale1 = maxHeight / img1.height;
                const scale2 = maxHeight / img2.height;
                const scaledWidth1 = img1.width * scale1;
                const scaledWidth2 = img2.width * scale2;
                const totalWidth = scaledWidth1 + scaledWidth2;
                
                canvas.width = totalWidth;
                canvas.height = maxHeight;
                
                // Fill background
                ctx.fillStyle = '#374151'; // gray-700
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                // Draw original image (left)
                ctx.drawImage(img1, 0, 0, scaledWidth1, maxHeight);
                
                // Draw generated image (right)
                ctx.drawImage(img2, scaledWidth1, 0, scaledWidth2, maxHeight);
                
                // Add watermark to generated side
                const watermarkText = 'www.rehome.today';
                const fontSize = Math.max(16, maxHeight / 40);
                ctx.font = `${fontSize}px Arial`;
                ctx.fillStyle = 'rgba(0, 0, 0, 0.6)';
                
                const textMetrics = ctx.measureText(watermarkText);
                const textWidth = textMetrics.width;
                const textHeight = fontSize;
                const padding = 10;
                
                // Draw background
                ctx.fillRect(
                    scaledWidth1 + scaledWidth2 - textWidth - padding * 2,
                    maxHeight - textHeight - padding * 2,
                    textWidth + padding * 2,
                    textHeight + padding * 2
                );
                
                // Draw text
                ctx.fillStyle = 'white';
                ctx.fillText(
                    watermarkText,
                    scaledWidth1 + scaledWidth2 - textWidth - padding,
                    maxHeight - padding
                );
                
                // Download
                canvas.toBlob((blob) => {
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'rehome-compared-' + Date.now() + '.png';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                }, 'image/png');
            }
        };
        
        img1.onload = onImageLoad;
        img2.onload = onImageLoad;
        img1.onerror = () => {
            alert('Анхны зураг ачаалж чадсангүй');
        };
        img2.onerror = () => {
            alert('Үүсгэсэн зураг ачаалж чадсангүй');
        };
        
        img1.src = originalImg.src;
        img2.src = generatedImg.src;
    }

    // Add event listeners for download buttons (will be set up when page loads)
    // These are set up at the end of the script initialization

    // Logout function
    function logout() {
        window.location.href = '/logout/';
    }

    // Get CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Account Modal Functions
    function openAccountModal() {
        const modal = document.getElementById('account-modal');
        modal.classList.remove('hidden');
        loadAccountData();
    }

    function closeAccountModal() {
        const modal = document.getElementById('account-modal');
        modal.classList.add('hidden');
    }

    async function loadAccountData() {
        try {
            const response = await fetch('/api/dashboard/');
            const data = await response.json();
            
            // Update user info
            document.getElementById('account-username').textContent = data.user.username;
            document.getElementById('account-email').textContent = data.user.email || 'Email байхгүй';
            
            // Update credit balance
            currentCreditBalance = data.credit_balance || 0;
            document.getElementById('account-credit-balance').textContent = currentCreditBalance;
            document.getElementById('modal-credit-balance').textContent = currentCreditBalance;
            document.getElementById('credit-balance').textContent = currentCreditBalance;
            checkAndShowLowCreditWarning(currentCreditBalance);
            
            // Load transactions
            loadModalTransactions(data.recent_transactions);
            
            // Load images
            loadModalImages(data.generated_images);
            
        } catch (error) {
            console.error('Error loading account data:', error);
        }
    }

    function loadModalTransactions(transactions) {
        const container = document.getElementById('modal-transactions-list');
        
        if (transactions.length === 0) {
            container.innerHTML = '<div class="px-6 py-4 text-gray-500 text-center">Гүйлгээ байхгүй</div>';
            return;
        }
        
        container.innerHTML = transactions.map(transaction => {
            const typeClass = transaction.transaction_type === 'add' ? 'text-green-400' : 'text-red-400';
            const typeIcon = transaction.transaction_type === 'add' ? '+' : '-';
            const date = new Date(transaction.created_at).toLocaleDateString('mn-MN');
            
            return `
                <div class="px-6 py-4 flex items-center justify-between">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <div class="w-8 h-8 bg-gray-600 rounded-full flex items-center justify-center">
                                <span class="text-sm font-medium ${typeClass}">${typeIcon}</span>
                            </div>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-white">${transaction.description}</p>
                            <p class="text-sm text-gray-400">${date}</p>
                        </div>
                    </div>
                    <div class="text-sm ${typeClass} font-medium">
                        ${typeIcon}${transaction.amount} кредит
                    </div>
                </div>
            `;
        }).join('');
    }

    function loadModalImages(images) {
        const container = document.getElementById('modal-images-grid');
        const noImages = document.getElementById('modal-no-images');
        
        if (images.length === 0) {
            container.classList.add('hidden');
            noImages.classList.remove('hidden');
            return;
        }
        
        container.classList.remove('hidden');
        noImages.classList.add('hidden');
        
        container.innerHTML = images.map(image => {
            const date = new Date(image.created_at).toLocaleDateString('mn-MN');
            
            return `
                <div class="bg-gray-600 rounded-lg overflow-hidden hover:shadow-lg transition-shadow border border-gray-500">
                    <div class="aspect-w-16 aspect-h-12 bg-gray-700">
                        <img src="${image.generated_image}" alt="Generated design" class="w-full h-48 object-cover">
                    </div>
                    <div class="p-4">
                        <h4 class="text-sm font-medium text-white capitalize">${image.style} Загвар</h4>
                        <p class="text-sm text-gray-400 mt-1">${date}</p>
                        <button onclick="showComparisonModal('${image.original_image}', '${image.generated_image}', '${image.style}')" 
                                class="mt-2 text-primary-400 hover:text-primary-300 text-sm font-medium">
                            Харьцуулах
                        </button>
                    </div>
                </div>
            `;
        }).join('');
    }

    // Global variables for payment
    let currentOrderId = null;
    let paymentPollingInterval = null;

    async function purchaseCredits() {
        document.getElementById('purchase-modal').classList.remove('hidden');
        await loadPackagesForPurchase();
    }

    function closePurchaseModal() {
        document.getElementById('purchase-modal').classList.add('hidden');
    }

    // Load packages for purchase modal
    async function loadPackagesForPurchase() {
        try {
            const response = await fetch('/api/packages/');
            const data = await response.json();
            
            const container = document.getElementById('packages-list');
            if (!container) return;
            
            if (data.packages && data.packages.length > 0) {
                container.innerHTML = '';
                
                data.packages.forEach((pkg, index) => {
                    const isPopular = index === 1; // Second package is popular
                    const packageCard = document.createElement('div');
                    packageCard.className = `bg-gray-700 rounded-lg p-6 border ${isPopular ? 'border-2 border-primary-500' : 'border-gray-600'} hover:border-primary-500 transition-colors relative overflow-visible`;
                    
                    let badgeHtml = '';
                    if (isPopular) {
                        badgeHtml = `
                            <div class="absolute -top-3 left-4 bg-primary-500 text-white text-xs px-3 py-1.5 rounded-full font-semibold z-10 shadow-lg">
                                Эрэлттэй
                            </div>
                        `;
                    }
                    
                    packageCard.innerHTML = `
                        ${badgeHtml}
                        <div class="text-center mb-4">
                            <h4 class="text-xl font-bold text-white mb-2">${pkg.name}</h4>
                            <div class="text-3xl font-bold text-white mb-1">${pkg.price.toLocaleString()}₮</div>
                            <p class="text-gray-400 text-sm">${pkg.credits} кредит</p>
                        </div>
                        <ul class="space-y-2 mb-4 text-sm text-gray-300">
                            <li class="flex items-center">
                                <svg class="w-4 h-4 text-green-400 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                                </svg>
                                ${pkg.credits} кредит
                            </li>
                            <li class="flex items-center">
                                <svg class="w-4 h-4 text-green-400 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                                </svg>
                                Бүх төрлийн интерьер
                            </li>
                        </ul>
                        <button onclick="purchasePackage(${pkg.id})" class="w-full ${isPopular ? 'bg-primary-600 hover:bg-primary-700' : 'bg-gray-600 hover:bg-gray-500'} text-white py-2 rounded-lg font-semibold transition-colors">
                            Сонгох
                        </button>
                    `;
                    container.appendChild(packageCard);
                });
            } else {
                container.innerHTML = '<div class="text-center text-gray-400 py-8 col-span-full">Багц олдсонгүй</div>';
            }
        } catch (error) {
            console.error('Error loading packages:', error);
            const container = document.getElementById('packages-list');
            if (container) {
                container.innerHTML = '<div class="text-center text-red-400 py-8 col-span-full">Багцуудыг ачаалахад алдаа гарлаа</div>';
            }
        }
    }

    // Purchase package
    async function purchasePackage(packageId) {
        // Close purchase modal
        closePurchaseModal();
        
        // Show QPay payment modal
        openQPayPaymentModal();
        showQPayLoading();
        
        try {
            const response = await fetch('/api/purchase-credits/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken'),
                },
                body: JSON.stringify({
                    package_id: packageId
                })
            });
            
            const data = await response.json();
            
            if (response.ok && data.qpay_invoice && data.order) {
                // Store order ID for polling
                currentOrderId = data.order.id;
                // Show QPay payment info
                showQPayPayment(data.qpay_invoice);
                // Start polling for payment status
                startPaymentPolling();
            } else {
                showQPayError(data.error || 'Төлбөрийн мэдээлэл авахад алдаа гарлаа');
            }
        } catch (error) {
            console.error('Error purchasing package:', error);
            showQPayError('Сүлжээний алдаа. Дахин оролдоно уу.');
        }
    }

    // QPay Payment Modal functions
    function openQPayPaymentModal() {
        document.getElementById('qpay-payment-modal').classList.remove('hidden');
    }

    function closeQPayPaymentModal() {
        document.getElementById('qpay-payment-modal').classList.add('hidden');
        stopPaymentPolling();
        // Reset modal state
        document.getElementById('qpay-loading').classList.remove('hidden');
        document.getElementById('qpay-qr-section').classList.add('hidden');
        document.getElementById('qpay-apps-section').classList.add('hidden');
        document.getElementById('qpay-error').classList.add('hidden');
        document.getElementById('qpay-success').classList.add('hidden');
        currentOrderId = null;
    }

    function showQPayLoading() {
        document.getElementById('qpay-loading').classList.remove('hidden');
        document.getElementById('qpay-qr-section').classList.add('hidden');
        document.getElementById('qpay-apps-section').classList.add('hidden');
        document.getElementById('qpay-error').classList.add('hidden');
        document.getElementById('qpay-success').classList.add('hidden');
    }

    function showQPayPayment(qpayInvoice) {
        document.getElementById('qpay-loading').classList.add('hidden');
        document.getElementById('qpay-error').classList.add('hidden');
        
        // Show QR code
        if (qpayInvoice.qr_image) {
            document.getElementById('qpay-qr-image').src = 'data:image/png;base64,' + qpayInvoice.qr_image;
            document.getElementById('qpay-qr-section').classList.remove('hidden');
        }
        
        // Show short URL
        if (qpayInvoice.qPay_shortUrl) {
            const shortUrlLink = document.getElementById('qpay-short-url');
            shortUrlLink.href = qpayInvoice.qPay_shortUrl;
            shortUrlLink.textContent = qpayInvoice.qPay_shortUrl;
        }
        
        // Show payment apps
        if (qpayInvoice.urls && qpayInvoice.urls.length > 0) {
            const appsGrid = document.getElementById('qpay-apps-grid');
            appsGrid.innerHTML = '';
            
            qpayInvoice.urls.forEach(app => {
                const appCard = document.createElement('a');
                appCard.href = app.link;
                appCard.target = '_blank';
                appCard.className = 'bg-gray-700 rounded-lg p-4 hover:bg-gray-600 transition-colors text-center';
                appCard.innerHTML = `
                    <img src="${app.logo}" alt="${app.name}" class="w-12 h-12 mx-auto mb-2 rounded" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=\\'http://www.w3.org/2000/svg\\' width=\\'48\\' height=\\'48\\'%3E%3Crect fill=\\'%234b5563\\' width=\\'48\\' height=\\'48\\'/%3E%3C/svg%3E'">
                    <p class="text-white text-sm font-semibold">${app.name}</p>
                    <p class="text-gray-400 text-xs mt-1">${app.description}</p>
                `;
                appsGrid.appendChild(appCard);
            });
            
            document.getElementById('qpay-apps-section').classList.remove('hidden');
        }
    }

    function showQPayError(message) {
        document.getElementById('qpay-loading').classList.add('hidden');
        document.getElementById('qpay-qr-section').classList.add('hidden');
        document.getElementById('qpay-apps-section').classList.add('hidden');
        document.getElementById('qpay-success').classList.add('hidden');
        document.getElementById('qpay-error').classList.remove('hidden');
        document.getElementById('qpay-error').textContent = message;
        stopPaymentPolling();
    }

    function showQPaySuccess(credits) {
        document.getElementById('qpay-loading').classList.add('hidden');
        document.getElementById('qpay-qr-section').classList.add('hidden');
        document.getElementById('qpay-apps-section').classList.add('hidden');
        document.getElementById('qpay-error').classList.add('hidden');
        document.getElementById('qpay-success').classList.remove('hidden');
        document.getElementById('qpay-success-credits').textContent = `${credits} кредит дансанд нэмэгдлээ.`;
        stopPaymentPolling();
        
        // Reload account data and close modal after 2 seconds
        setTimeout(() => {
            loadAccountData();
            closeQPayPaymentModal();
        }, 2000);
    }

    // Payment status polling
    function startPaymentPolling() {
        if (!currentOrderId) return;
        
        // Check immediately
        checkPaymentStatus();
        
        // Then check every 3 seconds
        paymentPollingInterval = setInterval(() => {
            checkPaymentStatus();
        }, 3000);
    }

    function stopPaymentPolling() {
        if (paymentPollingInterval) {
            clearInterval(paymentPollingInterval);
            paymentPollingInterval = null;
        }
    }

    async function checkPaymentStatus() {
        if (!currentOrderId) return;
        
        try {
            const response = await fetch(`/api/check-order-status/?order_id=${currentOrderId}`, {
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                }
            });
            
            const data = await response.json();
            
            if (response.ok && data.is_paid) {
                // Payment successful
                showQPaySuccess(data.credits);
            }
        } catch (error) {
            console.error('Error checking payment status:', error);
            // Don't show error, just continue polling
        }
    }

    // Close QPay modal on background click
    document.getElementById('qpay-payment-modal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeQPayPaymentModal();
        }
    });

    // Comparison modal (from dashboard/account modal)
    function showComparisonModal(originalImage, generatedImage, style) {
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-gray-900 bg-opacity-75 z-50 flex items-center justify-center p-4';
        modal.innerHTML = `
            <div class="bg-gray-800 rounded-lg max-w-4xl w-full max-h-full overflow-auto border border-gray-700">
                <div class="p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-medium text-white">${style} Загварын харьцуулалт</h3>
                        <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-white">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    <div class="relative bg-gray-700 rounded-lg overflow-hidden">
                        <div class="relative w-full h-96">
                            <div class="absolute inset-0 overflow-hidden">
                                <img src="${originalImage}" alt="Анхны" class="w-full h-full object-cover">
                            </div>
                            <div class="absolute inset-0 overflow-hidden" style="clip-path: inset(0 50% 0 0);">
                                <img src="${generatedImage}" alt="Үүсгэсэн" class="w-full h-full object-cover">
                            </div>
                            <div class="absolute inset-0 bg-gradient-to-r from-transparent via-gray-800 to-transparent opacity-30"></div>
                            <div class="absolute top-0 left-1/2 transform -translate-x-1/2 w-1 h-full bg-primary-500 shadow-lg"></div>
                            <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-8 h-8 bg-primary-500 rounded-full shadow-lg flex items-center justify-center cursor-move">
                                <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 9l4-4 4 4m0 6l-4 4-4-4"></path>
                                </svg>
                            </div>
                            <div class="absolute bottom-4 left-4 bg-black bg-opacity-70 text-white px-2 py-1 rounded text-sm">
                                Анхны
                            </div>
                            <div class="absolute bottom-4 right-4 bg-primary-600 bg-opacity-90 text-white px-2 py-1 rounded text-sm">
                                ${style} Загвар
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        
        // Add slider functionality
        const slider = modal.querySelector('.cursor-move');
        const afterImage = modal.querySelector('div:nth-child(2)');
        let isDragging = false;

        slider.addEventListener('mousedown', () => isDragging = true);
        document.addEventListener('mouseup', () => isDragging = false);
        document.addEventListener('mousemove', (e) => {
            if (!isDragging) return;
            
            const container = modal.querySelector('.relative.w-full');
            const rect = container.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const percentage = (x / rect.width) * 100;
            const clampedPercentage = Math.max(0, Math.min(100, percentage));
            
            afterImage.style.clipPath = `inset(0 ${100 - clampedPercentage}% 0 0)`;
            slider.style.left = `${clampedPercentage}%`;
        });
    }
});
</script>
</body>
</html>

